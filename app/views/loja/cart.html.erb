<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" >
        <meta name="viewport" content="width=device-width, initial-scale=1" > 
        <link href="https://fonts.googleapis.com/css?family=Titillium+Web:200,300,400,700" rel="stylesheet">
        <link rel="stylesheet" href="/css/bootstrap.css" >
        <link rel="stylesheet" href="/css/css.css" >

        <script src="https://use.fontawesome.com/7f3531401e.js"></script>

        <title>Pizza Prime</title>
    </head>
    <body>
        <div id="fb-root"></div>
        <script>(function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) return;
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.8&appId=662174687264933";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>
        <%= render :partial => 'header', :locals => {:page => 'loja'} %><br>
        <br>
        <br>
        <br>
        <div class="content clear">   
            <h2 class="center">Minha Caixa</h2>
            <% if session[:caixa].nil? %>

                <br>
                <div class="alert alert-warning center" > Você ainda não possui pizzas adicionadas ao carrinho </div>

            <% else %>
                <%
                    total = 0
                %>
                <br>
                <p><strong><%= session[:name] %>, </strong> você possui <%= session[:caixa] %> pizzas adicionadas</p>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Quantidade</th>
                            <th>Thumb</th>
                            <th>Tamanho</th>
                            <th>Pizza</th>
                            <th>Massa</th>
                            <th>Borda</th>
                            <th>Integral</th>
                            <th>2º Sabor</th>
                            <th>Valor</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                <% session[:pizzas].each do |p|  %>
                    <% 
                    pizza = Pizza.find(p[1]['tastes'][0]['id']) 
                    border = Border.find(p[1]['border_id'])
                    tamanho = Tamanho.find(p[1]['size_id'])
                    pedido_total = 0

                    border.price_tables.where(:tamanho_id => p[1]['size_id'], :store_ids => session[:store]['id']).each do |b| 
                        pedido_total += b.price
                    end

                    if p[1]['tastes'].length > 1

                        value1 = 0
                        value2 = 0
                        pizza22 = Pizza.find(p[1]['tastes'][1]['id'])

                        pizza.price_tables.where(:tamanho_id => p[1]['size_id'], :pizza_id => p[1]['tastes'][0]['id'], :store_ids => session[:store]['id']).each do |t|
                            value1 = t.price
                        end
                        pizza22.price_tables.where(:tamanho_id => p[1]['size_id'], :pizza_id => p[1]['tastes'][1]['id'], :store_ids => session[:store]['id']).each do |t|
                            value2 = t.price
                        end
                        
                        if value1 > value2
                            pedido_total += value1
                        else
                            pedido_total += value2
                        end


                    else    

                        pizza.price_tables.where(:tamanho_id => p[1]['size_id'], :pizza_id => p[1]['tastes'][0]['id'], :store_ids =>session[:store]['id']).each do |t|
                            pedido_total += t.price
                        end

                    end

                    pedido_total = pedido_total * p[1]['quantity']

                    if p[1]['integral'] == true
                        pedido_total += pizza.stores.where(:id => session[:store]['id']).first.integral
                    end

                    total += pedido_total
                    %>
                    <tr>
                        <td><%= p[1]['quantity'] %></td>
                        <td><img src="<%= pizza.picture %>" alt="Pizza Prime" title="Pizza Prime" style="width:100px" /></td>
                        <td><%= tamanho.name %></td>
                        <td><%= p[0] %></td>
                        <td><%= p[1]['pasta'] %></td>
                        <td><%= border[:name] %></td>
                        <td><% if p[1]['integral'] == true %> Sim <% else %> Não <% end %></td>
                        <td>
                            
                            <% if p[1]['tastes'].length > 1 %> 

                                <% pizza2 = Pizza.find(p[1]['tastes'][1]['id']) %>

                                <%= pizza2[:name] %>

                            <% else %> N/S <% end %>
                            
                        </td>
                        <td><%= number_to_currency(pedido_total, unit: 'R$ ', separator: ',') %></td>
                        <td>
                            <i class="fa fa-pencil fa-2x" data-toggle="modal" data-target="#<%= pizza.id %>" style="cursor:pointer" ></i>
                            &nbsp; &nbsp;
                            <i class="fa fa-trash fa-2x" style="cursor:pointer" onclick="location.href='<%= del_path(p[0]) %>'"></i>
                        </td>
                    </tr>
                    

                    <div id="<%= pizza.id %>" class="modal fade" tabindex="-1" role="dialog">
                              <div class="modal-dialog" role="document">
                                <div class="modal-content defaultcolor">
                                  <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title">Editar Produto</h4>
                                  </div>
                                  <div class="modal-body">

                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="img-pizza">
                                                <img src="<%= pizza.picture %>" alt="<%= pizza.name %>" title="<%= pizza.name %>" style="filter:none; -webkit-filter:none;" >
                                            </div>
                                        </div>
                                        <div class="col-md-9">
                                            <h3 class="center"><%= pizza.name %></h3>
                                            <br>
                                            <p><%= pizza.description %></p>
                                            <%= form_for :cart, url: edit_cart_path do |f| %>
                                                <%= f.hidden_field :name, :value => pizza.name %>
                                                <%= f.hidden_field :size, :value => tamanho.id %>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p>Escolha a borda</p>
                                                        <%= f.select(:borders ) do %>
                                                            <%= content_tag(:option, border[:name], value: border[:id].to_s) %>
                                                            <% @store.borders.each do |border| %>
                                                                <%= content_tag(:option, border[:name], value: border[:id]) %>
                                                            <% end %>
                                                        <% end %>
                                                        <br>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <p>Quantidade: </p>
                                                        <%= f.number_field :quantity, :class => 'form-control', :placeholder => 'Quantidade', :value => p[1]['quantity'] %>
                                                        <br>
                                                    </div>                                         
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p>Massa</p>
                                                        <%= f.select(:massa ) do %>
                                                            <%= content_tag(:option, p[1]['pasta']) %>
                                                            <%= content_tag(:option, 'Fina') %>
                                                            <%= content_tag(:option, 'Média') %>
                                                            <%= content_tag(:option, 'Grossa') %>
                                                        <% end %>
                                                    </div>
                                                    <div class="col-md-6">
                                                    <br>
                                                        <% if p[1]['integral'] == true %>
                                                            <p><%= f.check_box :integral, :checked => true %> &nbsp; &nbsp; Pizza Integral </p>
                                                        <% else %>
                                                            <p><%= f.check_box :integral %> &nbsp; &nbsp; Pizza Integral </p>
                                                        <% end %>
                                                    </div>
                                                </div>
                                                
                                                <br>
                                                <p>Observações: </p>
                                                <%= f.text_area :obs, :class => 'form-control', :placeholder => 'Observações', :value => p[1]['obs'] %>
                                                <br>
                                                <p class="btn btn-default" onclick="segundosabor()">Adicionar 2º sabor</p><br>
                                                <br>
                                                <%= f.hidden_field :sabor1, :value => p[1]['tastes'][0]['id'] %>
                                                <div class="segundo-sabor hidden">
                                                    <p>Selecione o 2º sabor:</p>
                                                    <%= f.select(:sabor2) do %>
                                                        <% if p[1]['tastes'].length > 1 %> 

                                                            <% pizza2 = Pizza.find(p[1]['tastes'][1]['id']) %>

                                                             <%= content_tag(:option, pizza2[:name], value: pizza2[:id].to_s) %>

                                                        <% else %> 
                                                           <%= content_tag(:option, '2º Sabor', value: 'none') %>

                                                        <% end %>
                                                        
                                                        <% @store.pizzas.each do |p| %>
                                                            <%= content_tag(:option, p[:name], value: p[:id]) %>
                                                        <% end %>
                                                    <% end %>
                                                    <br>
                                                </div>

                                                <%= f.submit 'Editar Carrinho', :class => 'right btn btn-success' %>
                                                <div class="clear"></div>
                                            <% end %>
                                        </div>
                                    </div>
                                    
                                  </div>
                                </div><!-- /.modal-content -->
                              </div><!-- /.modal-dialog -->
                            </div><!-- /.modal -->



                <% end %>
                    </tbody>

                </table>
                <br>

                <% if !session[:bebidas].blank? %>
                    <hr>
                    <h3 class="center">Bebidas</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Quantidade</th>
                                <th>Thumb</th>
                                <th>Nome</th>
                                <th>Preço</th>
                                <th></th>
                            </tr>
                        </thead>                        
                        <tbody>
                            <% session[:bebidas].each do |key, value| %>
                                <% @bebida = Beverage.find(key) %>
                                <% bebidaValor = value['price'].to_i * value['qtd'].to_i %>
                                <% total += bebidaValor %>
                                <tr>
                                    <td><%= value['qtd'] %></td>
                                    <td><img src="<%= @bebida.picture %>" alt="Pizza Prime" title="Pizza Prime" style="width:100px" /></td>
                                    <td><%= @bebida.name %></td>
                                    <td><%= number_to_currency(bebidaValor, unit: 'R$ ', separator: ',') %></td>
                                    <td>
                                        <i class="fa fa-trash fa-2x" style="cursor:pointer" onclick="location.href='<%= bebemenos_path(key) %>'"></i>
                                    </td>
                                </tr>    
                            <% end %>
                        </tbody>
                    </table>

                <% end %>


                <div class="text-right">
                    <h3>Total: <%= number_to_currency(total, unit: 'R$ ', separator: ',') %></h3>
                    <br>
                    <button class="btn btn-primary" onclick="location.href='<%= checkout_path %>'">Finalizar Compra</button>
                </div>
                

            <% end %>



            <br>
            <div class="center">
                <button class="btn btn-default" onclick="location.href='<%= cardapio_path %>'">Voltar a Loja</button>
            </div>

        </div><br>
        <br><br><br>
       <%= render 'footer' %>

        <script type="text/javascript" src="/js/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="/js/bootstrap.js"></script>
        <script type="text/javascript" src="/js/main.js"></script>
      
    </body>
</html>
